<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard</title>
    <link rel ="stylesheet" href="{{ url_for('static', path='/admin.css') }}">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container-fluid">
            <div class="brand-logo">EMS</div>
            <div class="ms-auto">
                <button class="btn btn-warning">
                    <a href="/logout">
                        <i class="fas fa-sign-out-alt me-2"></i>Logout
                    </a>
                </button>
            </div>
        </div>
    </nav>

    <div class="sidebar">
        <h5>Employee Management System</h5><br>
        <a href="#dashboard" class="active">Dashboard</a>
        <a href="#log-history">Log History</a>
        <a href="#leaves">Leave Requests</a>
        <a href="#add-employee">Add New Employee</a>
        <a href="#profile">Profile</a>

    </div>

    <main class="main-content">
        <div id="dashboard" class="section">
            <div class="card-grid stat-row">
                <div class="card stat-card">
                    <h3>Total Employees</h3>
                    <div class="stat-value">125</div>
                    <div class="stat-change">+5 this month</div>
                </div>
                <div class="card stat-card">
                    <h3>Present Today</h3>
                    <div class="stat-value">98</div>
                    <div class="stat-change">85% attendance</div>
                </div>
                <div class="card stat-card">
                    <h3>Pending Leaves</h3>
                    <div class="stat-value">12</div>
                    <div class="stat-change">3 new today</div>
                </div>
                <div class="card stat-card">
                    <h3>Active Projects</h3>
                    <div class="stat-value">8</div>
                    <div class="stat-change">2 nearing deadline</div>
                </div>
            </div>

            <!-- <div class="card mt-4">
                <h2>Employee Attendance Calendar</h2>
                <div id="calendar"></div>
            </div> -->

            <div class="card mt-4" id="attendance-chart-section">
                <h2>Attendance Trend</h2>
                <canvas id="attendanceLineChart" height="250"></canvas>
            </div>
        </div>

        <!-- Add Employee -->
        {% if employee.role %}
        <div class="card mt-4 section" id="add-employee">
            <h2>Add New Employee</h2>
            <form action="/register" method="post" class="row g-3" style="max-width: 500px; margin: 0 auto;">
                <input type="hidden" name="employee_id" value="{{ employee.id }}">
                <div class="col-md-12">
                    <label for="name" class="form-label">Full Name</label>
                    <input type="text" class="form-control" id="name" name="name" required>
                </div>
                <div class="col-md-12">
                    <label for="email" class="form-label">Email</label>
                    <input type="email" class="form-control" id="email" name="email" required>
                </div>
                <div class="col-md-12">
                    <label for="password" class="form-label">Password</label>
                    <input type="password" class="form-control" id="password" name="password" required>
                </div>
                <div class="col-md-12">
                    <label for="role" class="form-label">Role</label>
                    <select class="form-select" id="role" name="role" required>
                        <option value="employee">Employee</option>
                        <option value="admin">Admin</option>
                    </select>
                </div>
                <div class="col-12 text-center">
                    <button type="submit" class="btn btn-primary">Add Employee</button>
                </div>
                {% if add_employee_success %}
                <div class="alert alert-success mt-3" role="alert">
                    Employee added successfully!
                </div>
                {% endif %}
            </form>
        </div>
        {% endif %}

        <!-- Leave Requests  -->
        <div class="card mt-4 section" id="leaves">
            <h2>Pending Leave Requests</h2>
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>Employee</th>
                        <th>Leave Period</th>
                        <th>Reason</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                {% for leave in leaves %}
                    <tr>
                        <td>{{ leave.employee.name|capitalize if leave.employee else 'N/A' }}</td>
                        <td>{{ leave.start_date.strftime('%d %b %Y') }} - {{ leave.end_date.strftime('%d %b %Y') }}</td>
                        <td>{{ leave.reason }}</td>
                        <td>
                            {% if leave.status == 'approved' %}
                                <span class="badge bg-success">Approved</span>
                            {% elif leave.status == 'rejected' %}
                                <span class="badge bg-danger">Rejected</span>
                            {% else %}
                                <span class="badge bg-warning text-dark">Pending</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if leave.status == 'pending' %}
                                <form action="/dashboard/leave-action" method="post" style="display:inline;">
                                    <input type="hidden" name="leave_id" value="{{ leave.id }}">
                                    <button type="submit" name="action" value="approve" class="btn btn-success btn-sm">Approve</button>
                                    <button type="submit" name="action" value="reject" class="btn btn-danger btn-sm">Reject</button>
                                </form>
                            {% elif leave.status == 'approved' %}
                                <span class="text-success">Leave Approved</span>
                            {% elif leave.status == 'rejected' %}
                                <span class="text-danger">Leave Rejected</span>
                            {% endif %}
                        </td>
                    </tr>
                {% else %}
                    <tr><td colspan="5" class="text-center">No pending leave requests.</td></tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
        
        <!-- Log History -->
        <div class="card mt-4 section" id="log-history">
            <h2>Leave Log History</h2>
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>Employee</th>
                        <th>Leave Period</th>
                        <th>Reason</th>
                        <th>Status</th>
                        <th>Action Date</th>
                    </tr>
                </thead>
                <tbody>
                {% for leave in all_leaves %}
                    {% if leave.status != 'pending' %}
                    <tr>
                        <td>{{ leave.employee.name|capitalize if leave.employee else 'N/A' }}</td>
                        <td>{{ leave.start_date.strftime('%d %b %Y') }} - {{ leave.end_date.strftime('%d %b %Y') }}</td>
                        <td>{{ leave.reason }}</td>
                        <td>
                            {% if leave.status == 'approved' %}
                                <span class="badge bg-success">Approved</span>
                            {% elif leave.status == 'rejected' %}
                                <span class="badge bg-danger">Rejected</span>
                            {% endif %}
                        </td>
                        <td>{{ leave.updated_at.strftime('%d %b %Y %H:%M') if leave.updated_at else '-' }}</td>
                    </tr>
                    {% endif %}
                {% else %}
                    <tr><td colspan="5" class="text-center">No leave actions yet.</td></tr>
                {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Employee Profile -->
        <div class="d-flex justify-content-center" id="profile">
            <div class="card mt-4 section" id="profile" style="max-width: 400px; width: 100%;">
                <div class="card-header bg-primary text-white text-center">
                    <h4 class="mb-0">Employee Profile</h4>
                </div>
                <div class="card-body">
                    <div class="mb-3 text-center">
                        <i class="fa fa-user-circle fa-5x text-secondary"></i>
                    </div>
                    <table class="table table-borderless">
                        <tr>
                            <th>Name:</th>
                            <td>{{ employee.name }}</td>
                        </tr>
                        <tr>
                            <th>Email:</th>
                            <td>{{ employee.email }}</td>
                        </tr>
                        <tr>
                            <th>Role:</th>
                            <td>{% if employee.role %}Admin{% else %}Employee{% endif %}</td>
                        </tr>
                        <tr>
                            <th>ID:</th>
                            <td>{{ employee.id }}</td>
                        </tr>
                    </table>
                    <div class="text-center mt-4">
                        <a href="#dashboard" class="btn btn-secondary">Back to Dashboard</a>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script>
        document.querySelectorAll('.sidebar a').forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                document.querySelectorAll('.sidebar a').forEach(l => l.classList.remove('active'));
                this.classList.add('active');
                document.querySelectorAll('.section').forEach(section => section.style.display = 'none');
                const target = document.querySelector(this.getAttribute('href'));
                if (target) target.style.display = 'block';
            });
        });

        // Show dashboard by default
        document.querySelectorAll('.section').forEach(section => section.style.display = 'none');
        document.querySelector('#dashboard').style.display = 'block';

        // Calendar Initialization
        document.addEventListener('DOMContentLoaded', function() {
            var calendarEl = document.getElementById('calendar');
            if (calendarEl) {
                var calendar = new FullCalendar.Calendar(calendarEl, {
                    initialView: 'dayGridMonth',
                    events: [
                        { title: 'Present', date: '2025-07-28', color: '#198754' },
                        { title: 'On Leave', date: '2025-07-26', color: '#ffc107' },
                        { title: 'Absent', date: '2025-07-25', color: '#dc3545' }
                    ]
                });
                calendar.render();
            }

            // Line Chart for Attendance Trend
            var ctx = document.getElementById('attendanceLineChart').getContext('2d');
            // Example data: Replace with real attendance data from backend
            var attendanceLabels = ['July 21', 'July 22', 'July 23', 'July 24', 'July 25', 'July 26', 'July 27', 'July 28'];
            var attendanceData = [90, 92, 95, 93, 98, 97, 99, 98];
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: attendanceLabels,
                    datasets: [{
                        label: 'Employees Present',
                        data: attendanceData,
                        borderColor: '#198754',
                        backgroundColor: 'rgba(25,135,84,0.1)',
                        tension: 0.3,
                        fill: true,
                        pointRadius: 4,
                        pointBackgroundColor: '#198754',
                        pointBorderColor: '#fff',
                        pointHoverRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: true, position: 'top' },
                        title: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: { display: true, text: 'Employees Present' }
                        },
                        x: {
                            title: { display: true, text: 'Date' }
                        }
                    }
                }
            });
        });
    </script>
</body>
</html>
